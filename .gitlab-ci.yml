variables:
  # GITLAB_API_URL: 'https://gitlab.tpwd.de/api'
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_AUTH_CONFIG: '{ "auths": { "https://index.docker.io/v1/": { "auth": "$DOCKER_AUTH" } }}'
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  QUANTUM_CLI: registry.internal.planetary-networks.de/quantum-public/cli:2
  QUANTUM_ENDPOINT: tpwd-bb-navi
  QUANTUM_PROJECT: digitransit-ui

stages:
  - lint-test
  - build-push
  - predeploy
  - deploy

services:
  - docker:19.03-dind

.only-on-bbnavi-pushes-or-release-tags:
  only:
    - '$CI_DEFAULT_BRANCH'
    - /^release_[\w-]+_\d{4}-\d{2}-\d{2}$/

.only-on-release-tags:
  only:
    - /^release_[\w-]+_\d{4}-\d{2}-\d{2}$/
  except:
    - branches

test-and-lint:
  stage: lint-test
  image:
    # We mirror the Dockerfile here.
    name: node:10.23
  script:
    - yarn install --immutable
    - yarn build-workspaces
    - yarn run lint
    - yarn run relay
    - yarn run test-unit
  cache:
    key: $CI_PROJECT_PATH_SLUG-yarn-cache
    paths:
      - .yarn/cache
  interruptible: true

build-and-push-docker-img:
  extends:
    - .only-on-bbnavi-pushes-or-release-tags
  stage: build-push
  variables:
    TAG: $CI_COMMIT_SHA
    CACHE_TAG: $CI_COMMIT_REF_NAME
  before_script:
    - docker login -u $DOCKERHUB_LOGIN -p $DOCKERHUB_PASSWORD
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    # Only build & push the :$TAG Docker image if it doesn't exist jet.
    # Also, pull :$CACHE_TAG before & push it after, to leverage Docker caching.
    # https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#make-docker-in-docker-builds-faster-with-docker-layer-caching
    # todo: don't pull Docker image, just check if it exists
    # - export CONTAINER_REPOSITORY_ID="$(curl "$GITLAB_API_URL/v4/projects/$CI_PROJECT_ID/registry/repositories' -H "PRIVATE-TOKEN: $CI_JOB_TOKEN" -s | jq -rc '.[] | [.id, .path]' | grep -m1 "$CI_PROJECT_PATH" | jq '.[0]')"
    # - if ! curl "$GITLAB_API_URL/v4/projects/$CI_PROJECT_ID/registry/repositories/$$CONTAINER_REPOSITORY_ID/tags/$TAG' -H "PRIVATE-TOKEN: $CI_JOB_TOKEN" -s -f -o /dev/null
    - >
      if ! docker pull $DOCKER_IMAGE:$TAG; then
        docker pull $DOCKER_IMAGE:$CACHE_TAG || true

        docker build --cache-from $DOCKER_IMAGE:$CACHE_TAG --tag $DOCKER_IMAGE:$TAG .
        docker push $DOCKER_IMAGE:$TAG

        docker tag $DOCKER_IMAGE:$TAG $DOCKER_IMAGE:$CACHE_TAG
        docker push $DOCKER_IMAGE:$CACHE_TAG
      fi

generate-quantum-config:
  extends:
    - .only-on-release-tags
  variables:
    DOCKER_TAG: $CI_COMMIT_SHA
  stage: predeploy
  image:
    name: docker/compose:1.25.5
  cache:
    key: "${CI_PIPELINE_ID}-${QUANTUM_PROJECT}"
    paths: [quantum.yml]
  before_script:
    # strip "release_" prefix & date suffix from Git tag, export as $BBNAVI_CONFIG
    - apk add --upgrade --no-cache pcre2-tools
    - export BBNAVI_CONFIG="$(echo -n "$CI_COMMIT_TAG" | pcre2grep -o1 '(?:release_)([\w-]+)(?:_\d{4}-\d{2}-\d{2})')"
  script:
    - docker-compose -f docker-compose.yml -f deployment/stack.yml -f "deployment/stack.$BBNAVI_CONFIG.yml" config | tee quantum.yml

deploy-using-quantum:
  extends:
    - .only-on-release-tags
  stage: deploy
  image: $QUANTUM_CLI
  cache:
    key: "${CI_PIPELINE_ID}-${QUANTUM_PROJECT}"
    paths: [quantum.yml]
  script:
    - quantum-cli stack update --create --stack "$QUANTUM_PROJECT-$QUANTUM_ENDPOINT" --wait
  tags: [v2]
